---
title: "Histologies File QC"
data: 2021-03-08 
output:
  pdf_document:
    latex_engine: xelatex
author: "Jo Lynne Rokita, Krutika Gaonkar (D3B)"
params:
  latest_release:
    label: "folder for latest pull of base histology"
    value: kfnbl/kfnbl-histologies.txt
    input: file
  prev_release:
    label: "folder for previous release of base histology"
    value: release-v18-20201123/pbta-histologies.tsv
    input: file  
  add_ids:
    label: "add Kids_First_Biospecimen_IDs from base not in previous release"
    value: ""
    input: string
  remove_ids:
    label: "remove Kids_First_Biospecimen_IDs from previous release in ouput"
    value: ""
    input: string   
toc: TRUE
toc_float: TRUE
editor_options: 
  chunk_output_type: inline
---

In this notebook we are genrating a report for the latest histology file.


```{r global_options, include=F}
library(knitr)
hook_output = knit_hooks$get('output')
knit_hooks$set(output = function(x, options) {
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) {
    x = knitr:::split_lines(x)
    # any lines wider than n should be wrapped
    if (any(nchar(x) > n)) x = strwrap(x, width = n)
    x = paste(x, collapse = '\n')
  }
  hook_output(x, options)
})

opts_chunk$set(error = FALSE, echo=FALSE,message=FALSE,warning=FALSE,linewidth=100)


```


# Load packages
```{r}
suppressMessages(library(emo))
suppressMessages(library(tidyverse))

```

# Directories and Files
## Directories
```{r}
# Input directory
input_dir <- file.path("input")
# soft linked previous release histology
prev_hist_file <- file.path(params$prev_release)

# adapt histology
latest_hist_file <- file.path(params$latest_release)

##--- KEEP LINK to G-DRIVE --- ##

# pathology diagnosis is needed to match tumor samples 
# to broad/short histology
#path_dx <- read_sheet('https://docs.google.com/spreadsheets/d/1fDXt_YODcSAWDvyI5ISBVhUCu4b5-TFCVWMOwiPeMwk/edit#gid=0',range="pathology_diagnosis_for_subtyping") %>%
#  dplyr::select(pathology_diagnosis,broad_histology, short_histology) %>%
#  write_tsv(file.path(input_dir,"pathology_diagnosis_for_subtyping.tsv"))

# pathology free text diagnosis is needed to match to 
# samples marked as "Other" in pathology_diagnosis
#path_free_text <- read_sheet('https://docs.google.com/spreadsheets/d/1fDXt_YODcSAWDvyI5ISBVhUCu4b5-TFCVWMOwiPeMwk/edit#gid=0',range="pathology_free_text_diagnosis_for_subtyping") %>%
#  dplyr::select(pathology_free_text_diagnosis,broad_histology, short_histology)%>%
#  write_tsv(file.path(input_dir,"pathology_free_text_diagnosis_for_subtyping.tsv"))

## ----------- ##


```


### Read in old base histology

```{r}
prev_hist <- read_tsv(prev_hist_file,
                      # NAs are being read as logical so specifying as character here
                           col_types = readr::cols(molecular_subtype = readr::col_character(),
                                                   short_histology = readr::col_character(),
                                                   integrated_diagnosis = readr::col_character(),
                           broad_histology = readr::col_character(),
                           Notes = readr::col_character()))

path_dx <- read_tsv(file.path(input_dir,"pathology_diagnosis_for_subtyping.tsv")) %>%
  dplyr::select(pathology_diagnosis, broad_histology, short_histology)
path_free_text <- read_tsv(file.path(input_dir,"pathology_free_text_diagnosis_for_subtyping.tsv")) %>%
  dplyr::select(pathology_free_text_diagnosis, broad_histology, short_histology)

```

### Read new file to review 
```{r}
latest_hist <- read_tsv(latest_hist_file,
                      # NAs are being read as logical so specifying as character here
                           col_types = readr::cols(molecular_subtype = readr::col_character(),
                                                   short_histology = readr::col_character(),
                                                   integrated_diagnosis = readr::col_character(),
                           broad_histology = readr::col_character(),
                           Notes = readr::col_character()))

```

## Check 1: Assess dimensions whether new column names match the old 

### Check 1b: assess columns overlap in new and old 
```{r}
check_cols(new_hist = latest_hist,old_hist = prev_hist)

```

## Check 2: Assess levels of histology columns


### Check 2a Experimental strategy 

```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "experimental_strategy")

```

### Check 2b Sample Type  
```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "sample_type")


```


### Check 2c Tumor Descriptor 

```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "tumor_descriptor")

```

### Check 2d Composition  
```{r}
# update composition with to match new terms to previous composition terms


check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "composition")

```

### Check 2e RNA library 
```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "RNA_library")

```

### Check 2f: Cohort
```{r}
check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "cohort")
```

### Check 2g: Sequencing Center 
```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "seq_center")

```

### Check 2h: primary_site 
```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "primary_site")

```

### Check 2i: path_dx and path_free_text_dx is used to match later so should have the same values in new histology

```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "pathology_diagnosis")

```


```{r}

check_rows(new_hist = latest_hist,old_hist = prev_hist,
          column_name = "pathology_free_text_diagnosis")
```

### Check 2j: Normals, these should not have path_dx, int_dx,molecular_subtype, broad/short_hist `r emo::ji("x")`
```{r}
latest_hist_normals <- latest_hist %>% 
  filter(sample_type=="Normal")
prev_hist_normals <- prev_hist %>%
  filter(sample_type=="Normal")

key_column_name = c("pathology_free_text_diagnosis","pathology_diagnosis","molecular_subtype",
                    "broad_histology","short_histology")

print("The following normals have values in key columns diagnosis related columns ,please review")
latest_hist_normals %>% filter_at(vars(key_column_name) , any_vars(!is.na(.))) %>%
  select(Kids_First_Biospecimen_ID,all_of(key_column_name)) %>%
  # Normals should not have values in these columns
  pull(Kids_First_Biospecimen_ID) 
  

```



```{r}
sessionInfo()
```

